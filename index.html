<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Munetios Notebook (Archived) title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<!-- Lexend -->
<link href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:opsz,wght,ROND@6..144,1..1000,80&display=swap" rel="stylesheet">
<!-- Boost SEO -->
<meta name="description" content="Create your own journal with Munetios Notebook. Organize your notes, ideas, and projects in one place. Start writing today!">
<meta name="keywords" content="Munetios Notebook, notebook, journal creation, note-taking, writing, organization, projects">
<meta name="author" content="Munetios">
<meta property="og:title" content="Munetios Notebook - Create your own journal">
<meta property="og:description" content="Create your own journal with Munetios Notebook. Organize your notes, ideas, and projects in one place. Start writing today!">
<meta property="og:type" content="website">
<meta property="og:url" content="https://notebook.munetios.com/">
<meta property="og:image" content="https://notebook.munetios.com/android-chrome-192x192.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Munetios Notebook - Create your own journal">
<meta name="twitter:description" content="Create your own journal with Munetios Notebook. Organize your notes, ideas, and projects in one place. Start writing today!">
<meta name="twitter:image" content="https://notebook.munetios.com/android-chrome-192x192.png">

<!-- End Boost SEO -->
 <style>
    * {
        font-family: 'Google Sans Flex', sans-serif !important;
           font-variation-settings:
          "GRAD" 30,
          "ROND" 80,
          "opsz" 18;
        font-feature-settings:
          "ss02" off,
          "liga" off,
          "clig" off;
    }
    body {
        font-family: 'Google Sans Flex', sans-serif;
           font-variation-settings:
          "wght" 480,
          "GRAD" 30,
          "ROND" 80,
          "opsz" 18;
        font-feature-settings:
          "ss02" off,
          "liga" off,
          "clig" off;
        margin: 0;
        padding: 0;
        background-color: #210041;
        color: #ffffff;
    }
    .liquid-glass {
        backdrop-filter: blur( 2px )  saturate(180%) brightness(80%) contrast(85%);
        background: rgba(255, 255, 255, 0.1);
        border-radius: 159px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }
    .logo {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .logo-text {
        font-size: 24px;
        font-weight: 600;
        white-space: nowrap;
    }
     .topbar {
        width: 100%;
        padding: 10px 20px;
        box-sizing: border-box;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        left: 0;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.1);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }
    .btn {
        background: none;
        border: none;
        color: white;
        background-color: #4109c2;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 12px 18px;
        border-radius: 48px;
        transition: background-color 0.3s, transform 0.2s;
    }
    .btn:hover {
        background-color: #5a1ed6;
        transform: translateY(-2px);
    }
    .btn:active {
        transform: translateY(0);
    }
    .create-label {
        font-weight: 500;
    }
    #settingsbtn, #helpbtn, #appsbtn {
        background-color: transparent;
        padding: 8px;
        border-radius: 50%;
    }
    .top-right {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .search-bar {
        display: flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 48px;
        padding: 8px 12px;
        gap: 8px;
        flex: 1;
        max-width: 768px;
        margin: 0 20px;
    }
    .search-bar input {
        border: none !important;
        background: transparent !important;
        color: white;
        font-size: 16px;
        outline: none !important;
        width: 100%;
    }
    .sidebar {
        width: 80px;
        height: 100vh;
        position: fixed;
        top: 70px;
        left: 0;
        overflow-y: auto;
        padding: 20px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-right: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }
    .sidebar-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        font-size: 14px;
        padding: 10px;
        border-radius: 12px;
        transition: background-color 0.3s, transform 0.2s;
    }
    .sidebar-item:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }
    .modal-content {
        background: rgba(22, 0, 58, 0.85); /* Added transparency */
        padding: 20px;
        border-radius: 12px;
        width: 90%;
        max-width: 700px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(5px); /* Optional: glass effect */
    }
    .content {
        margin-left: 100px;
        padding: 20px;
    }
    input[type="text"], input[type="search"], input[type="password"], textarea {
        background: rgba(255,255,255,0.15);
        border: 1px solid rgba(255,255,255,0.25);
        border-radius: 32px;
        padding: 10px 16px;
        color: #fff;
        font-size: 16px;
        outline: none;
        transition: border-color 0.2s, background 0.2s;
        box-sizing: border-box;
    }

    input[type="text"]:focus, input[type="search"]:focus, input[type="password"]:focus, textarea:focus {
        border-color: #a884ff;
        background: rgba(255,255,255,0.22);
    }

    input[type="text"]::placeholder, input[type="search"]::placeholder, textarea::placeholder {
        color: #e0d6f7;
        opacity: 1;
    }

    .newTagContainer {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 18px;
    }
    .editor-screen {
        display: none;
    }
    .top-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .home {
        cursor: pointer;
    }
    .home:hover {
        transform: translateY(-2px);
    }
    .home:active {
        transform: translateY(0);
    }
    .top-left #notebookName {
        font-size: 20px;
        font-weight: 600;
        white-space: nowrap;
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .sort-select {
        background: rgba(255,255,255,0.15);
        border: 1px solid rgba(255,255,255,0.25);
        border-radius: 32px;
        padding: 10px 16px;
        color: #fff;
        font-size: 16px;
        outline: none;
        transition: border-color 0.2s, background 0.2s;
        box-sizing: border-box;
        margin-bottom: 18px;
    }
    .sort-select:focus {
        border-color: #a884ff;
        background: rgba(255,255,255,0.22);
    }
    .sort-select option {
        background: #210041;
        color: #fff;
    }
    .more-wrapper {
        position: relative;
        display: none;
    }
    .more-icon {
        cursor: pointer;
    }
    .more-icon:hover {
        transform: translateY(-2px);
    }
    .more-icon:active {
        transform: translateY(0);
    }
    .options {
        position: absolute;
        top: 40px;
        right: 0;
        background: rgba(22, 0, 58, 0.37);
        border-radius: 12px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(5px);
        overflow: hidden;
        z-index: 1500;
    }
    .option {
        padding: 10px 20px;
        cursor: pointer;
        white-space: nowrap;
        transition: background-color 0.2s;
    }
    .apps-wrapper {
        position: relative;
        display: none;
        z-index: 1500;
        margin-top: 10px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        overflow: hidden;
        backdrop-filter: blur(5px);
        background: rgba(22, 0, 58, 0.164);
        padding: 12px 16px;

    }
    @media (max-width: 900px) {
        .logo-text {
            display: none;
        }
    }
    @media (max-width: 700px) {
        .last-modified {
            display: none;
        }
    }
    @media (max-width: 680px) {
        .create-label {
            display: none;
        }
        .content {
            margin-left: 70px;
        }
        .content h1 {
            font-size: 1.5rem;
        }
    }
    @media (max-width: 500px) {
        #appsbtn {
            display: none;
        }
        .sidebar {
            position: fixed;
            top: auto;
            bottom: 0;
            left: 0;
            width: 100vw;
            height: 64px;
            flex-direction: row;
            padding: 0 10px;
            border-right: none;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.1);
            z-index: 1200;
            justify-content: space-around;
            align-items: center;
            overflow-x: auto;
            overflow-y: hidden;
            gap: 0;
        }
        .sidebar-items {
            flex-direction: row;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 0;
        }
        .sidebar-item {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0 8px;
            font-size: 12px;
            min-width: 60px;
            min-height: 48px;
            border-radius: 8px;
        }
        .content, #tagsContent {
            margin-left: 0 !important;
            margin-bottom: 70px !important;
        }
    }
    @media (max-width: 440px) {
        .logo {
            display: none;
        }
        .topbar {
            flex-wrap: wrap;
        }
    }
 </style>
</head>
<body>
    <div class="home-screen">
    <div class="topbar liquid-glass">
        <div class="logo">
            <img src="image.png" alt="Munetios Notebook Logo" style="height: 50px;">
            <div class="logo-text">Munetios Notebook</div>
        </div>
        <div class="search-bar">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" fill="none"/>
                <line x1="16" y1="16" x2="21" y2="21" stroke="currentColor" stroke-width="2"/>
            </svg>
            <input type="text" id="searchInput" placeholder="Search">
        </div>
        <div class="top-right">
             <button class="btn" id="createbtn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <line x1="12" y1="6" x2="12" y2="18" stroke="currentColor" stroke-width="2"/>
                    <line x1="6" y1="12" x2="18" y2="12" stroke="currentColor" stroke-width="2"/>
                </svg>
                <div class="create-label">Create</div>
             </button>
             <!-- Do Settings, Help, Apps icon-->
                <button class="btn" id="settingsbtn">
                  <svg height="28" width="28" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.48.398.668 1.03.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37-.49l1.217.456c.355.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
                <button class="btn" id="helpbtn">
                  <svg width="28" height="28" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z"></path></svg>
                </button>
                <button class="btn" id="appsbtn">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="4" height="4" rx="1" fill="currentColor"/>
                        <rect x="10" y="3" width="4" height="4" rx="1" fill="currentColor"/>
                        <rect x="17" y="3" width="4" height="4" rx="1" fill="currentColor"/>
                        <rect x="3" y="10" width="4" height="4" rx="1" fill="currentColor"/>
                        <rect x="10" y="10" width="4" height="4" rx="1" fill="currentColor"/>
                        <rect x="17" y="10" width="4" height="4" rx="1" fill="currentColor"/>
                        <rect x="3" y="17" width="4" height="4" rx="1" fill="currentColor"/>
                        <rect x="10" y="17" width="4" height="4" rx="1" fill="currentColor"/>
                        <rect x="17" y="17" width="4" height="4" rx="1" fill="currentColor"/>
                    </svg>
                </button>
                <div class="apps-wrapper">
                    <iframe src="https://www.munetios.com/apps" width="450" height="768" frameborder="0"></iframe>
                </div>
        </div>
    </div>
    <div class="sidebar liquid-glass">
        <div class="sidebar-items">
            <div class="sidebar-item">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 7C3 5.34315 4.34315 4 6 4H18C19.6569 4 21 5.34315 21 7V17C21 18.6569 19.6569 20 18 20H6C4.34315 20 3 18.6569 3 17V7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M3 7H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M16 4V20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="sidebar-item-text">Notebooks</div>
            </div>
            <div class="sidebar-item">
                <!-- Tag icon -->
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20.59 13.41L11 3.83V3a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h.83l9.59 9.59a2 2 0 0 0 2.83 0l3.34-3.34a2 2 0 0 0 0-2.83z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="7.5" cy="7.5" r="1.5" fill="currentColor"/>
                </svg>
                <div class="sidebar-item-text">Tags</div>
            </div>
            <div class="sidebar-item">
                <!-- Archive icon -->
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="3" width="18" height="4" rx="1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M5 7V19a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 12h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="sidebar-item-text">Archives</div>
            </div>
            <div class="sidebar-item">
                <!-- Trash icon -->
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M10 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="sidebar-item-text">Trash</div>
            </div>
        </div>
    </div>
    <div class="content" id="notebooksContent">
        <h1>Welcome to Munetios Notebook</h1>
        <!-- Sort By -->
        <select class="sort-select" id="sortBySelect">
            <option value="lastModifiedDesc">Last Modified (Newest)</option>
            <option value="lastModifiedAsc">Last Modified (Oldest)</option>
            <option value="createdDesc">Created (Newest)</option>
            <option value="createdAsc">Created (Oldest)</option>
            <option value="titleAsc">Title (A-Z)</option>
            <option value="titleDesc">Title (Z-A)</option>
            </select>
        <p>Note: Munetios Notebook is no longer releasing updates. use <a href="https://write.munetios.com">Munetios OmniWrite</a> for updates</p>
        <div id="notebooks"></div>
    </div>
    <div class="content" id="tagsContent">
        <h1>Tags</h1>
        <div class="newTagContainer">
            <input type="text" style="width: 100%;" id="newTagInput" placeholder="New Tag Name" />
            <button class="btn" style="white-space: nowrap;" id="addTagBtn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <line x1="12" y1="6" x2="12" y2="18" stroke="currentColor" stroke-width="2"/>
                    <line x1="6" y1="12" x2="18" y2="12" stroke="currentColor" stroke-width="2"/>
                </svg>
                <div class="create-label">Add Tag</div>
            </button>
        </div>
        <div id="tags"></div>
    </div>
    <div class="content" id="archivesContent">
        <h1>Archives</h1>
        <div id="archives"></div>
    </div>
    <div class="content" id="trashContent">
        <h1>Trash</h1>
        <div id="trash"></div>
        </div>
    </div>
    <div class="editor-screen">
        <div class="topbar liquid-glass">
            <div class="top-left">
        <div class="home" id="backHome">
            <!-- Use svg so use menu icon -->
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 12H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M3 6H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <div id="notebookName"></div>
        <div class="last-modified" id="lastmodified"></div>
    </div>
        <div class="top-right">
            <!-- Do Undo, redo, bg color, resize notebook, share button with text, more icon -->
             <div class="findinpage-icon" id="findinpage">
    <!-- Standard Find in Page Icon -->
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="7"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
    </svg>

             </div>
<div class="undo-icon" id="undoBtn" title="Undo">
    <!-- Standard Undo Icon -->
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 14L4 9l5-5"/>
        <path d="M20 20v-1a7 7 0 0 0-7-7H4"/>
    </svg>
</div>
<div class="redo-icon" id="redoBtn" title="Redo">
    <!-- Standard Redo Icon -->
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M15 14l5-5-5-5"/>
        <path d="M4 20v-1a7 7 0 0 1 7-7h9"/>
    </svg>
</div>
<div class="bgcolor-icon" id="bgColorBtn" title="Background Color">
    <!-- Palette Icon for Background Color (simplified, not a face) -->
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 1 9.79 9.79z"/>
        <circle cx="7.5" cy="10.5" r="1"/>
        <circle cx="12" cy="7.5" r="1"/>
        <circle cx="16.5" cy="14.5" r="1"/>
    </svg>
</div>
<div class="resize-icon" id="resizeBtn" title="Resize Notebook">
    <!-- Standard Resize Icon (Diagonal Arrows) -->
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="16 3 21 3 21 8"/>
        <line x1="21" y1="3" x2="14" y2="10"/>
        <polyline points="8 21 3 21 3 16"/>
        <line x1="3" y1="21" x2="10" y2="14"/>
    </svg>
</div>
                <button class="btn" id="shareBtn" title="Share Notebook">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="18" cy="5" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                        <circle cx="6" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                        <circle cx="18" cy="19" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" stroke="currentColor" stroke-width="2"/>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <div class="create-label">Share</div>
                </button>
                <div class="more-icon" title="More Options" id="moreBtn" style="display: flex; flex-direction: column; align-items: center;">
                    <svg width="28" height="28" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <circle cx="12" cy="6.5" r="1"/>
                        <circle cx="12" cy="12" r="1"/>
                        <circle cx="12" cy="17.5" r="1"/>
                    </svg>
                </div>
                <div class="more-wrapper liquid-glass">
                    <div class="options">
                        <div class="option" id="downloadastxt">Download as TXT</div>
                        <div class="option" id="downloadashtml">Download as HTML</div>
                        <!-- Do Print, Make a copy, Archive , move to trash-->
                        <div class="option" id="printNotebook">Print</div>
                        <div class="option" id="makeCopy">Make a Copy</div>
                        <div class="option" id="archiveNotebook">Archive</div>
                        <div class="option" id="moveToTrash">Move to Trash</div>
                    </div>
                </div>

        </div>
    </div>
    <div class="editor-content" style="padding: 32px 0; max-width: 1566px; margin: 0 auto;">
        <input type="text" id="editorTitle" placeholder="Page Title" style="width:100%;font-size:2rem;font-weight:600;margin-bottom:18px;background:rgba(255,255,255,0.08);border:none;color:#fff;padding:12px 18px;border-radius:16px;" />

        <div id="editorToolbar" style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap;">
            <button type="button" title="Bold" onclick="formatEditor('bold')" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;"><b>B</b></button>
            <button type="button" title="Italic" onclick="formatEditor('italic')" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;"><i>I</i></button>
            <button type="button" title="Underline" onclick="formatEditor('underline')" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;"><u>U</u></button>
            <button type="button" title="StrikeThrough" onclick="formatEditor('strikeThrough')" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;"><s>S</s></button>
            <button type="button" title="Bulleted List" onclick="formatEditor('insertUnorderedList')" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;">&#8226;â€¢&#8226;</button>
            <button type="button" title="Numbered List" onclick="formatEditor('insertOrderedList')" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;">1.</button>
            <input type="color" id="textColorPicker" title="Text Color" style="width:28px;height:28px;border:none;background:none;cursor:pointer;" onchange="formatEditor('foreColor', this.value)">
            </div>

            <div id="editorPages" style="margin-bottom:24px;">
                <!-- Pages will be rendered here -->
            </div>

            <button class="btn" id="addPageBtn" style="margin-top:18px;justify-content:center;width:100%;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <line x1="12" y1="6" x2="12" y2="18" stroke="currentColor" stroke-width="2"/>
                <line x1="6" y1="12" x2="18" y2="12" stroke="currentColor" stroke-width="2"/>
                </svg>
                <div class="create-label">Add Page</div>
            </button>
            </div>
            <script>
                document.getElementById('findinpage').addEventListener('click', function () {
                    // Remove any existing find bar
                    let oldBar = document.getElementById('findInPageBar');
                    if (oldBar) {
                        oldBar.remove();
                        removeFindHighlights();
                        return;
                    }
                    // Create floating search bar
                    const bar = document.createElement('div');
                    bar.id = 'findInPageBar';
                    bar.className = 'liquid-glass';
                    bar.style.position = 'fixed';
                    bar.style.top = '90px';
                    bar.style.right = '32px';
                    bar.style.zIndex = 3000;
                    bar.style.display = 'flex';
                    bar.style.alignItems = 'center';
                    bar.style.gap = '8px';
                    bar.style.padding = '10px 18px';
                    bar.style.borderRadius = '32px';
                    bar.style.boxShadow = '0 4px 30px rgba(0,0,0,0.18)';
                    bar.innerHTML = `
                        <input type="text" id="findInPageInput" placeholder="Find in page..." style="background:rgba(255,255,255,0.18);border:none;color:#fff;padding:8px 14px;border-radius:18px;font-size:16px;outline:none;width:180px;">
                        <span id="findInPageCount" style="font-size:14px;color:#e0d6f7;"></span>
                        <button id="findInPagePrev" class="btn" style="padding:4px 10px;font-size:13px;">&#8593;</button>
                        <button id="findInPageNext" class="btn" style="padding:4px 10px;font-size:13px;">&#8595;</button>
                        <button id="findInPageClose" class="btn" style="padding:4px 10px;font-size:13px;">&times;</button>
                    `;
                    document.body.appendChild(bar);

                    let matches = [];
                    let currentIdx = 0;

                    function highlightMatches(query) {
                        removeFindHighlights();
                        matches = [];
                        if (!query) {
                            updateCount();
                            return;
                        }
                        // Search all .page-content in editor
                        document.querySelectorAll('.editor-page .page-content').forEach((div, pageIdx) => {
                            let html = div.innerHTML;
                            // Remove previous highlights
                            html = html.replace(/<span class="find-highlight[^"]*">(.*?)<\/span>/g, '$1');
                            // Find matches (case-insensitive)
                            let regex = new RegExp(escapeRegExp(query), 'gi');
                            let idx = 0;
                            html = html.replace(regex, function (match) {
                                matches.push({ pageIdx, matchIdx: idx++ });
                                return `<span class="find-highlight">${match}</span>`;
                            });
                            div.innerHTML = html;
                        });
                        updateCount();
                        scrollToCurrent();
                    }

                    function updateCount() {
                        const count = matches.length;
                        const countSpan = document.getElementById('findInPageCount');
                        if (count === 0) {
                            countSpan.textContent = '';
                        } else {
                            countSpan.textContent = `${currentIdx + 1} of ${count}`;
                        }
                    }

                    function scrollToCurrent() {
                        // Remove previous active
                        document.querySelectorAll('.find-highlight-active').forEach(el => el.classList.remove('find-highlight-active'));
                        if (matches.length === 0) return;
                        // Find all highlights
                        let allHighlights = Array.from(document.querySelectorAll('.find-highlight'));
                        let el = allHighlights[currentIdx];
                        if (el) {
                            el.classList.add('find-highlight-active');
                            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        updateCount();
                    }

                    function removeFindHighlights() {
                        document.querySelectorAll('.editor-page .page-content').forEach(div => {
                            div.innerHTML = div.innerHTML.replace(/<span class="find-highlight[^"]*">(.*?)<\/span>/g, '$1');
                        });
                    }

                    function escapeRegExp(str) {
                        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    }

                    // Style for highlight
                    const style = document.createElement('style');
                    style.textContent = `
                        .find-highlight {
                            background: #ffe066;
                            color: #222;
                            border-radius: 4px;
                            padding: 0 2px;
                        }
                        .find-highlight-active {
                            background: #ffd700;
                            color: #222;
                            outline: 2px solid #4109c2;
                        }
                    `;
                    document.head.appendChild(style);

                    // Input events
                    const input = document.getElementById('findInPageInput');
                    input.focus();
                    input.addEventListener('input', function () {
                        currentIdx = 0;
                        highlightMatches(this.value.trim());
                    });

                    // Next/Prev buttons
                    document.getElementById('findInPageNext').addEventListener('click', function () {
                        if (matches.length === 0) return;
                        currentIdx = (currentIdx + 1) % matches.length;
                        scrollToCurrent();
                    });
                    document.getElementById('findInPagePrev').addEventListener('click', function () {
                        if (matches.length === 0) return;
                        currentIdx = (currentIdx - 1 + matches.length) % matches.length;
                        scrollToCurrent();
                    });

                    // Close button
                    document.getElementById('findInPageClose').addEventListener('click', function () {
                        bar.remove();
                        removeFindHighlights();
                        style.remove();
                    });

                    // ESC closes
                    input.addEventListener('keydown', function (e) {
                        if (e.key === 'Escape') {
                            bar.remove();
                            removeFindHighlights();
                            style.remove();
                        }
                        if (e.key === 'Enter' && matches.length > 0) {
                            currentIdx = (currentIdx + 1) % matches.length;
                            scrollToCurrent();
                        }
                    });

                    // Remove highlights on navigation away from editor
                    window.addEventListener('hashchange', function () {
                        bar.remove();
                        removeFindHighlights();
                        style.remove();
                    });

                    // Initial highlight if any
                    highlightMatches('');
                });
                function formatDateTime12h(ts) {
                    if (!ts) return '';
                    const d = new Date(ts);
                    let hours = d.getHours();
                    const minutes = d.getMinutes().toString().padStart(2, '0');
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    hours = hours % 12;
                    if (hours === 0) hours = 12;
                    const month = (d.getMonth() + 1).toString().padStart(2, '0');
                    const day = d.getDate().toString().padStart(2, '0');
                    const year = d.getFullYear();
                    return `${month}/${day}/${year} ${hours}:${minutes} ${ampm}`;
                }

                // Render last modified date in editor topbar
                function renderLastModified() {
                    const lastModDiv = document.getElementById('lastmodified');
                    if (!lastModDiv || !currentNotebookId) {
                        if (lastModDiv) lastModDiv.textContent = '';
                        return;
                    }
                    getNotebooksFromDB().then(notebooks => {
                        const notebook = notebooks.find(nb => nb.id === currentNotebookId);
                        if (!notebook || !notebook.updatedAt) {
                            lastModDiv.textContent = '';
                            return;
                        }
                        lastModDiv.textContent = 'Last Modified: ' + formatDateTime12h(notebook.updatedAt);
                    });
                }

                // Patch renderEditorPages and saveEditorPages to update last modified
                const origRenderEditorPagesForLastMod = renderEditorPages;
                renderEditorPages = function() {
                    origRenderEditorPagesForLastMod();
                    renderLastModified();
                };
                const origSaveEditorPagesForLastMod = saveEditorPages;
                saveEditorPages = function() {
                    origSaveEditorPagesForLastMod();
                    renderLastModified();
                };

                // Also update on notebook load
                window.addEventListener('hashchange', function() {
                    if (window.location.hash.startsWith('#/editor/')) {
                        setTimeout(renderLastModified, 0);
                    }
                });
                window.addEventListener('DOMContentLoaded', function() {
                    if (window.location.hash.startsWith('#/editor/')) {
                        setTimeout(renderLastModified, 0);
                    }
                });
                    const moreBtn = document.getElementById('moreBtn');
                    const moreWrapper = document.querySelector('.more-wrapper');

                    // Open more-wrapper on click, close on outside click
                    moreBtn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        moreWrapper.style.display = moreWrapper.style.display === 'block' ? 'none' : 'block';
                    });

                    // Close more-wrapper when clicking outside
                    document.addEventListener('click', function (e) {
                        if (!moreWrapper.contains(e.target) && e.target !== moreBtn) {
                            moreWrapper.style.display = 'none';
                        }
                    });
                    document.getElementById('downloadastxt').addEventListener('click', function () {
                        // Prepare plain text content
                        const title = notebookPages[0]?.title || 'Untitled Notebook';
                        let text = `${title}\n\n`;
                        notebookPages.forEach((page, idx) => {
                            text += `--- ${page.title} ---\n`;
                            // Strip HTML tags for plain text
                            const tmp = document.createElement('div');
                            tmp.innerHTML = page.content || '';
                            text += (tmp.textContent || tmp.innerText || '') + '\n\n';
                        });
                        // Download as .txt
                        const blob = new Blob([text], { type: 'text/plain' });
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = `${title.replace(/[^\w\d]+/g, '_')}.txt`;
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => {
                            URL.revokeObjectURL(a.href);
                            a.remove();
                        }, 100);
                        moreWrapper.style.display = 'none';
                    });
                    // Rename Notebook
                    const renameOption = document.createElement('div');
                    renameOption.className = 'option';
                    renameOption.id = 'renameNotebook';
                    renameOption.textContent = 'Rename Notebook';
                    // Insert as first option
                    moreWrapper.querySelector('.options').insertBefore(renameOption, moreWrapper.querySelector('.options').firstChild);

                    renameOption.addEventListener('click', async function () {
                        if (!currentNotebookId) {
                            showToast('No notebook loaded.');
                            return;
                        }
                        const notebooks = await getNotebooksFromDB();
                        const notebook = notebooks.find(nb => nb.id === currentNotebookId);
                        if (!notebook) {
                            showToast('Notebook not found.');
                            return;
                        }
                        showModal(`
                            <h2>Rename Notebook</h2>
                            <form id="renameNotebookForm" style="display:flex;flex-direction:column;gap:16px;">
                                <input type="text" id="renameNotebookTitle" value="${escapeHtml(notebook.title)}" style="width:100%;" required />
                                <button type="submit" class="btn" style="width:100%;justify-content:center;">Rename</button>
                            </form>
                        `);
                        document.getElementById('renameNotebookForm').addEventListener('submit', async function(e) {
                            e.preventDefault();
                            const newTitle = document.getElementById('renameNotebookTitle').value.trim();
                            if (!newTitle) return;
                            notebook.title = newTitle;
                            // Also update first page title if exists
                            if (notebook.pages && notebook.pages.length > 0) {
                                notebook.pages[0].title = newTitle;
                            }
                            await saveNotebookToDB(notebook);
                            document.getElementById('modal').remove();
                            showToast('Notebook renamed.');
                            renderNotebooks && renderNotebooks();
                            // Update editor title if in editor
                            if (window.location.hash.startsWith('#/editor/')) {
                                loadNotebookForEditor && loadNotebookForEditor();
                            }
                        });
                        moreWrapper.style.display = 'none';
                    });
                    // Download as Markdown
                    document.getElementById('downloadashtml').textContent = 'Download as MarkDown';
                    document.getElementById('downloadashtml').addEventListener('click', function () {
                        // Prepare Markdown content
                        const title = notebookPages[0]?.title || 'Untitled Notebook';
                        let md = `# ${title}\n\n`;
                        notebookPages.forEach((page, idx) => {
                            md += `## ${page.title}\n\n`;
                            // Convert HTML to Markdown (basic)
                            let html = page.content || '';
                            // Replace <b>, <strong> with **
                            html = html.replace(/<(b|strong)>(.*?)<\/\1>/gi, '**$2**');
                            // Replace <i>, <em> with *
                            html = html.replace(/<(i|em)>(.*?)<\/\1>/gi, '*$2*');
                            // Replace <u> with _
                            html = html.replace(/<u>(.*?)<\/u>/gi, '_$1_');
                            // Replace <s> with ~~
                            html = html.replace(/<s>(.*?)<\/s>/gi, '~~$1~~');
                            // Replace <ul> and <li>
                            html = html.replace(/<ul>([\s\S]*?)<\/ul>/gi, function(_, list) {
                                return list.replace(/<li>(.*?)<\/li>/gi, '- $1');
                            });
                            // Replace <ol> and <li>
                            html = html.replace(/<ol>([\s\S]*?)<\/ol>/gi, function(_, list) {
                                let i = 1;
                                return list.replace(/<li>(.*?)<\/li>/gi, () => `${i++}. $1`);
                            });
                            // Replace <br> with newlines
                            html = html.replace(/<br\s*\/?>/gi, '\n');
                            // Replace images
                            html = html.replace(/<img [^>]*src="([^"]+)"[^>]*>/gi, '![]($1)');
                            // Replace videos (show as link)
                            html = html.replace(/<video[^>]*>.*?<source src="([^"]+)".*?<\/video>/gi, '[Video]($1)');
                            // Remove all other HTML tags
                            html = html.replace(/<\/?[^>]+(>|$)/g, '');
                            md += html.trim() + '\n\n';
                        });
                        // Download as .md
                        const blob = new Blob([md], { type: 'text/markdown' });
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = `${title.replace(/[^\w\d]+/g, '_')}.md`;
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => {
                            URL.revokeObjectURL(a.href);
                            a.remove();
                        }, 100);
                        moreWrapper.style.display = 'none';
                    });
                    document.getElementById('printNotebook').addEventListener('click', function () {
                        // Print only the editor content, not the whole page
                        const editorContent = document.querySelector('.editor-content');
                        if (!editorContent) {
                            showToast('Nothing to print.');
                            return;
                        }
                        // Clone the editor content to avoid breaking the notebook
                        const printContent = editorContent.cloneNode(true);

                        // Remove toolbars, buttons, and inputs from print
                        printContent.querySelectorAll('button, .editorToolbar, .btn, input, select').forEach(el => el.remove());

                        // Create a print-only container
                        let printContainer = document.getElementById('printContainerMunetios');
                        if (!printContainer) {
                            printContainer = document.createElement('div');
                            printContainer.id = 'printContainerMunetios';
                            printContainer.style.display = 'none';
                            document.body.appendChild(printContainer);
                        }
                        printContainer.innerHTML = `
                            <style>
                                body { font-family: Poppins, sans-serif; color: #222; background: #fff; margin: 0; padding: 32px; }
                                h1 { font-size: 2rem; margin-bottom: 18px; }
                                h2 { font-size: 1.2rem; margin-top: 32px; margin-bottom: 10px; }
                                img, video { max-width: 100%; border-radius: 8px; margin: 8px 0; }
                                .page-break { page-break-after: always; }
                            </style>
                            ${printContent.innerHTML}
                        `;

                        // Print only the printContainer
                        const originalBody = document.body.innerHTML;
                        document.body.innerHTML = printContainer.innerHTML;

                        // Restore the DOM after print, or reload if needed
                        let printed = false;
                        window.onafterprint = function () {
                            // Try to restore DOM, but reload if things break
                            try {
                                document.body.innerHTML = originalBody;
                                // Remove the print container if it exists
                                const pc = document.getElementById('printContainerMunetios');
                                if (pc) pc.remove();
                                // Remove the handler
                                window.onafterprint = null;
                                // Optionally, re-run scripts or reload if needed
                                location.reload();
                            } catch (e) {
                                location.reload();
                            }
                        };
                        window.print();
                        moreWrapper.style.display = 'none';
                    });
                    document.getElementById('makeCopy').addEventListener('click', async function () {
                        if (!currentNotebookId) {
                            showToast('No notebook loaded.');
                            return;
                        }
                        const notebooks = await getNotebooksFromDB();
                        const notebook = notebooks.find(nb => nb.id === currentNotebookId);
                        if (!notebook) {
                            showToast('Notebook not found.');
                            return;
                        }
                        // Create a copy with new id and title
                        const newId = 'nb_' + Date.now();
                        const copy = {
                            ...JSON.parse(JSON.stringify(notebook)),
                            id: newId,
                            title: notebook.title + ' (Copy)',
                            createdAt: Date.now(),
                            updatedAt: Date.now()
                        };
                        await saveNotebookToDB(copy);
                        showToast('Notebook copied.');
                        moreWrapper.style.display = 'none';
                        renderNotebooks();
                        window.location.hash = `#/editor/${newId}`;
                    });

                    document.getElementById('archiveNotebook').addEventListener('click', async function () {
                        if (!currentNotebookId) {
                            showToast('No notebook loaded.');
                            return;
                        }
                        const notebooks = await getNotebooksFromDB();
                        const notebook = notebooks.find(nb => nb.id === currentNotebookId);
                        if (!notebook) {
                            showToast('Notebook not found.');
                            return;
                        }
                        notebook.archived = true;
                        await saveNotebookToDB(notebook);
                        showToast('Notebook archived.');
                        moreWrapper.style.display = 'none';
                        renderNotebooks();
                        window.location.hash = '';
                        document.querySelector('.editor-screen').style.display = 'none';
                        document.querySelector('.home-screen').style.display = '';
                        renderArchives();
                    });

                    document.getElementById('moveToTrash').addEventListener('click', async function () {
                        if (!currentNotebookId) {
                            showToast('No notebook loaded.');
                            return;
                        }
                        const notebooks = await getNotebooksFromDB();
                        const notebook = notebooks.find(nb => nb.id === currentNotebookId);
                        if (!notebook) {
                            showToast('Notebook not found.');
                            return;
                        }
                        notebook.trashed = true;
                        await saveNotebookToDB(notebook);
                        showToast('Notebook moved to trash.');
                        moreWrapper.style.display = 'none';
                        renderNotebooks();
                        window.location.hash = '';
                        document.querySelector('.editor-screen').style.display = 'none';
                        document.querySelector('.home-screen').style.display = '';
                        renderTrash();
                    });

                    // Render Archives
                    async function renderArchives() {
                        const container = document.getElementById('archives');
                        if (!container) return;
                        const notebooks = await getNotebooksFromDB();
                        const archived = notebooks.filter(nb => nb.archived && !nb.trashed);
                        container.innerHTML = '';
                        if (archived.length === 0) {
                            container.innerHTML = '<div style="color:#e0d6f7;">No archived notebooks.</div>';
                            return;
                        }
                        archived.forEach(nb => {
                            const div = document.createElement('div');
                            div.className = 'liquid-glass';
                            div.style.padding = '18px';
                            div.style.marginBottom = '18px';
                            div.style.borderRadius = '24px';
                            div.innerHTML = `
                                <div style="font-size:20px;font-weight:600;">${nb.title}</div>
                                ${nb.desc ? `<div style="color:#e0d6f7;margin:6px 0 0 0;">${nb.desc}</div>` : ''}
                                <button class="btn" style="margin-top:12px;" data-id="${nb.id}">Restore</button>
                            `;
                            div.querySelector('button').addEventListener('click', async function () {
                                nb.archived = false;
                                await saveNotebookToDB(nb);
                                showToast('Notebook restored.');
                                renderArchives();
                                renderNotebooks();
                            });
                            container.appendChild(div);
                        });
                    }

                    // Render Trash
                    async function renderTrash() {
                        const container = document.getElementById('trash');
                        if (!container) return;
                        const notebooks = await getNotebooksFromDB();
                        const trashed = notebooks.filter(nb => nb.trashed);
                        container.innerHTML = '';
                        if (trashed.length === 0) {
                            container.innerHTML = '<div style="color:#e0d6f7;">Trash is empty.</div>';
                            return;
                        }
                        trashed.forEach(nb => {
                            const div = document.createElement('div');
                            div.className = 'liquid-glass';
                            div.style.padding = '18px';
                            div.style.marginBottom = '18px';
                            div.style.borderRadius = '24px';
                            div.innerHTML = `
                                <div style="font-size:20px;font-weight:600;">${nb.title}</div>
                                ${nb.desc ? `<div style="color:#e0d6f7;margin:6px 0 0 0;">${nb.desc}</div>` : ''}
                                <button class="btn" style="margin-top:12px;margin-right:8px;" data-id="${nb.id}" data-action="recover">Recover</button>
                                <button class="btn" style="margin-top:12px;background:#c20909;" data-id="${nb.id}" data-action="delete">Delete Permanently</button>
                            `;
                            div.querySelectorAll('button').forEach(btn => {
                                btn.addEventListener('click', async function () {
                                    if (btn.dataset.action === 'recover') {
                                        nb.trashed = false;
                                        await saveNotebookToDB(nb);
                                        showToast('Notebook recovered.');
                                        renderTrash();
                                        renderNotebooks();
                                    } else if (btn.dataset.action === 'delete') {
                                        // Delete from DB
                                        const db = await openDB();
                                        await new Promise((resolve, reject) => {
                                            const tx = db.transaction('notebooks', 'readwrite');
                                            tx.objectStore('notebooks').delete(nb.id);
                                            tx.oncomplete = resolve;
                                            tx.onerror = reject;
                                        });
                                        showToast('Notebook deleted permanently.');
                                        renderTrash();
                                        renderNotebooks();
                                    }
                                });
                            });
                            container.appendChild(div);
                        });
                    }

                    // Render archives/trash on navigation
                    window.addEventListener('DOMContentLoaded', function () {
                        renderArchives();
                        renderTrash();
                    });
                    window.addEventListener('hashchange', function () {
                        if (window.location.hash === '#/archives') renderArchives();
                        if (window.location.hash === '#/trash') renderTrash();
                    });
                document.getElementById('resizeBtn').addEventListener('click', async function () {
                    // Get current notebook id and notebook
                    const notebookId = currentNotebookId;
                    if (!notebookId) {
                        showToast('No notebook loaded.');
                        return;
                    }
                    const notebooks = await getNotebooksFromDB();
                    const notebook = notebooks.find(nb => nb.id === notebookId);
                    if (!notebook) {
                        showToast('Notebook not found.');
                        return;
                    }
                    // Get current width/height or defaults
                    let width = (notebook.width || 900);
                    let height = (notebook.height || 700);

                    showModal(`
                        <h2>Resize Notebook</h2>
                        <form id="resizeNotebookForm" style="display:flex;flex-direction:column;gap:16px;">
                            <div>
                                <label for="notebookWidth" style="display:block;margin-bottom:4px;">Width (px)</label>
                                <input type="number" id="notebookWidth" min="400" max="2000" value="${width}" style="width:100%;"/>
                            </div>
                            <div>
                                <label for="notebookHeight" style="display:block;margin-bottom:4px;">Height (px)</label>
                                <input type="number" id="notebookHeight" min="300" max="2000" value="${height}" style="width:100%;"/>
                            </div>
                            <button type="submit" class="btn" style="width:100%;justify-content:center;">Apply</button>
                        </form>
                    `);

                    // Live preview on input
                    const editorContent = document.querySelector('.editor-content');
                    const widthInput = document.getElementById('notebookWidth');
                    const heightInput = document.getElementById('notebookHeight');
                    function applyPreview() {
                        editorContent.style.maxWidth = widthInput.value + 'px';
                        editorContent.style.minHeight = heightInput.value + 'px';
                        editorContent.style.height = heightInput.value + 'px';
                    }
                    widthInput.addEventListener('input', applyPreview);
                    heightInput.addEventListener('input', applyPreview);

                    // Set initial preview
                    applyPreview();

                    document.getElementById('resizeNotebookForm').addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const newWidth = Math.max(400, Math.min(2000, parseInt(widthInput.value, 10) || 900));
                        const newHeight = Math.max(300, Math.min(2000, parseInt(heightInput.value, 10) || 700));
                        // Save to notebook object
                        notebook.width = newWidth;
                        notebook.height = newHeight;
                        await saveNotebookToDB(notebook);
                        // Apply to editor
                        editorContent.style.maxWidth = newWidth + 'px';
                        editorContent.style.minHeight = newHeight + 'px';
                        editorContent.style.height = newHeight + 'px';
                        document.getElementById('modal').remove();
                        showToast('Notebook size updated.');
                    });
                });

                // On notebook load, apply width/height if set
                window.addEventListener('DOMContentLoaded', function () {
                    function applyNotebookSize() {
                        const editorContent = document.querySelector('.editor-content');
                        // Reset to default before applying new size
                        editorContent.style.maxWidth = '';
                        editorContent.style.minHeight = '';
                        editorContent.style.height = '';
                        const hash = window.location.hash;
                        const match = hash.match(/^#\/editor\/(.+)$/);
                        if (!match) return;
                        const notebookId = match[1];
                        getNotebooksFromDB().then(notebooks => {
                            const notebook = notebooks.find(nb => nb.id === notebookId);
                            if (!notebook) return;
                            if (notebook.width) editorContent.style.maxWidth = notebook.width + 'px';
                            if (notebook.height) {
                                editorContent.style.minHeight = notebook.height + 'px';
                                editorContent.style.height = notebook.height + 'px';
                            }
                        });
                    }
                    applyNotebookSize();
                    window.addEventListener('hashchange', applyNotebookSize);

                    // Also reset editor size when returning home
                    window.addEventListener('hashchange', function() {
                        if (!window.location.hash.startsWith('#/editor/')) {
                            const editorContent = document.querySelector('.editor-content');
                            if (editorContent) {
                                editorContent.style.maxWidth = '';
                                editorContent.style.minHeight = '';
                                editorContent.style.height = '';
                            }
                        }
                    });
                });


                document.getElementById('bgColorBtn').addEventListener('click', function () {
                    // Get current background color
                    const editorContent = document.querySelector('.editor-content');
                    let currentBg = window.getComputedStyle(editorContent).backgroundColor;
                    // Convert rgb to hex if needed
                    function rgbToHex(rgb) {
                        if (!rgb) return '#ffffff';
                        const result = rgb.match(/\d+/g);
                        if (!result) return '#ffffff';
                        return (
                            '#' +
                            result
                                .slice(0, 3)
                                .map(x => ('0' + parseInt(x).toString(16)).slice(-2))
                                .join('')
                        );
                    }
                    const currentHex = rgbToHex(currentBg);

                    showModal(`
                        <h2>Change Editor Background</h2>
                        <div style="margin-bottom:18px;">
                            <input type="color" id="editorBgColorPicker" value="${currentHex}" style="width:60px;height:60px;border:none;outline:none;cursor:pointer;border-radius:12px;background:none;">
                        </div>
                        <button class="btn" id="applyBgColorBtn" style="width:100%;justify-content:center;">Apply</button>
                    `);

                    const colorInput = document.getElementById('editorBgColorPicker');
                    colorInput.addEventListener('input', function () {
                        editorContent.style.background = colorInput.value;
                    });

                    document.getElementById('applyBgColorBtn').addEventListener('click', function () {
                        editorContent.style.background = colorInput.value;
                        // Optionally persist color in localStorage
                        localStorage.setItem('editorBgColor', colorInput.value);
                        document.getElementById('modal').remove();
                    });
                });

                // On load, restore editor background color if set
                window.addEventListener('DOMContentLoaded', function () {
                    const color = localStorage.getItem('editorBgColor');
                    if (color) {
                        const editorContent = document.querySelector('.editor-content');
                        if (editorContent) editorContent.style.background = color;
                    }
                });
                let undoStack = [];
                let redoStack = [];

                // Save current state to undo stack
                function pushUndoState() {
                    // Deep copy of notebookPages
                    undoStack.push(JSON.parse(JSON.stringify(notebookPages)));
                    // Clear redo stack on new action
                    redoStack = [];
                }

                // Restore state from stack
                function restoreEditorPagesFromStack(stackFrom, stackTo) {
                    if (stackFrom.length === 0) return;
                    stackTo.push(JSON.parse(JSON.stringify(notebookPages)));
                    notebookPages = JSON.parse(JSON.stringify(stackFrom.pop()));
                    renderEditorPages();
                    saveNotebookPagesToDB();
                }

                // Patch saveEditorPages to push undo state before saving
                const origSaveEditorPagesForUndo = saveEditorPages;
                saveEditorPages = function() {
                    pushUndoState();
                    origSaveEditorPagesForUndo();
                };

                // Undo/Redo button handlers
                document.getElementById('undoBtn').addEventListener('click', function() {
                    if (undoStack.length === 0) return;
                    restoreEditorPagesFromStack(undoStack, redoStack);
                });
                document.getElementById('redoBtn').addEventListener('click', function() {
                    if (redoStack.length === 0) return;
                    restoreEditorPagesFromStack(redoStack, undoStack);
                });

                // Initialize undo stack on notebook load
                window.addEventListener('hashchange', function() {
                    if (window.location.hash.startsWith('#/editor/')) {
                        undoStack = [];
                        redoStack = [];
                    }
                });
                window.addEventListener('DOMContentLoaded', function() {
                    if (window.location.hash.startsWith('#/editor/')) {
                        undoStack = [];
                        redoStack = [];
                    }
                });


            let currentNotebookId = null;
            let notebookPages = [];

            // Formatting toolbar HTML as a function so it can be reused per page
            function getToolbarHtml(idx) {
            return `
                <div class="editorToolbar" style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap;">
                <button type="button" title="Bold" onclick="formatEditorPage('bold', null, ${idx})" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;"><b>B</b></button>
                <button type="button" title="Italic" onclick="formatEditorPage('italic', null, ${idx})" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;"><i>I</i></button>
                <button type="button" title="Underline" onclick="formatEditorPage('underline', null, ${idx})" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;"><u>U</u></button>
                <button type="button" title="StrikeThrough" onclick="formatEditorPage('strikeThrough', null, ${idx})" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;"><s>S</s></button>
                <button type="button" title="Bulleted List" onclick="formatEditorPage('insertUnorderedList', null, ${idx})" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;">&#8226;â€¢&#8226;</button>
                <button type="button" title="Numbered List" onclick="formatEditorPage('insertOrderedList', null, ${idx})" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;">1.</button>
                <input type="color" title="Text Color" style="width:28px;height:28px;border:none;background:none;cursor:pointer;" onchange="formatEditorPage('foreColor', this.value, ${idx})">
                <button type="button" title="Insert Image" onclick="document.getElementById('imageInput'+${idx}).click()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;">
                    <!-- Image SVG icon -->
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" />
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <path d="M21 15l-5-5L5 21"/>
                    </svg>
                </button>
                <input type="file" id="imageInput${idx}" accept="image/*" style="display:none" onchange="insertImageFilePage(this, ${idx})">
                <button type="button" title="Insert Video" onclick="document.getElementById('videoInput'+${idx}).click()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;">
                    <!-- Standard Video SVG icon (rectangle with play triangle) -->
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="4" width="20" height="16" rx="2" />
                        <polygon points="10 8 16 12 10 16 10 8" fill="currentColor"/>
                    </svg>
                </button>
                <input type="file" id="videoInput${idx}" accept="video/*" style="display:none" onchange="insertVideoFilePage(this, ${idx})">
                </div>
            `;
            }

            function getCurrentNotebookIdFromHash() {
            const hash = window.location.hash;
            const match = hash.match(/^#\/editor\/(.+)$/);
            return match ? match[1] : null;
            }

            async function loadNotebookForEditor() {
            currentNotebookId = getCurrentNotebookIdFromHash();
            if (!currentNotebookId) return;
            const notebooks = await getNotebooksFromDB();
            const notebook = notebooks.find(nb => nb.id === currentNotebookId);
            if (!notebook) return;
            notebookPages = notebook.pages || [
                { title: notebook.title || "Untitled Page", content: notebook.content || "" }
            ];
            renderEditorPages();
            }

            function renderEditorPages() {
            const container = document.getElementById('editorPages');
            container.innerHTML = '';
            notebookPages.forEach((page, idx) => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'editor-page liquid-glass';
                pageDiv.style = 'padding:24px;margin-bottom:18px;border-radius:24px;position:relative;';
                pageDiv.innerHTML = `
                <input type="text" class="page-title" value="${escapeHtml(page.title)}" placeholder="Page Title" style="width:100%;font-size:1.3rem;font-weight:500;margin-bottom:10px;background:rgba(255,255,255,0.08);border:none;color:#fff;padding:8px 14px;border-radius:12px;" />
                ${getToolbarHtml(idx)}
                <div class="page-content" contenteditable="true" style="min-height:120px;background:rgba(255,255,255,0.06);border-radius:12px;padding:12px;color:#fff;outline:none;">${page.content || ''}</div>
                ${notebookPages.length > 1 ? `<button type="button" class="btn" style="position:absolute;top:12px;right:12px;padding:4px 10px;font-size:13px;" onclick="removePage(${idx})">Remove</button>` : ''}
                `;
                // Attach events for this page
                pageDiv.querySelector('.page-title').addEventListener('input', () => saveEditorPages());
                pageDiv.querySelector('.page-content').addEventListener('input', () => saveEditorPages());
                // Set active-editor class for first page by default
                if (idx === 0) pageDiv.querySelector('.page-content').classList.add('active-editor');
                container.appendChild(pageDiv);
            });
            }

            // Formatting for a specific page
            function formatEditorPage(cmd, value = null, idx = 0) {
            const pageDivs = document.querySelectorAll('.editor-page');
            const pageDiv = pageDivs[idx];
            if (!pageDiv) return;
            const contentDiv = pageDiv.querySelector('.page-content');
            if (!contentDiv) return;
            contentDiv.focus();
            document.execCommand(cmd, false, value);
            saveEditorPages();
            }

            // Insert image for a specific page
            function insertImageFilePage(input, idx) {
            const file = input.files && input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const pageDivs = document.querySelectorAll('.editor-page');
                const pageDiv = pageDivs[idx];
                if (!pageDiv) return;
                const contentDiv = pageDiv.querySelector('.page-content');
                if (!contentDiv) return;
                const img = `<img src="${e.target.result}" style="max-width:100%;border-radius:8px;margin:8px 0;" />`;
                contentDiv.focus();
                document.execCommand('insertHTML', false, img);
                saveEditorPages();
            };
            reader.readAsDataURL(file);
            input.value = '';
            }

            // Insert video for a specific page
            function insertVideoFilePage(input, idx) {
            const file = input.files && input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const pageDivs = document.querySelectorAll('.editor-page');
                const pageDiv = pageDivs[idx];
                if (!pageDiv) return;
                const contentDiv = pageDiv.querySelector('.page-content');
                if (!contentDiv) return;
                const video = `<video controls style="max-width:100%;border-radius:8px;margin:8px 0;"><source src="${e.target.result}"></video>`;
                contentDiv.focus();
                document.execCommand('insertHTML', false, video);
                saveEditorPages();
            };
            reader.readAsDataURL(file);
            input.value = '';
            }

            function saveEditorPages() {
            const pageDivs = document.querySelectorAll('.editor-page');
            notebookPages = Array.from(pageDivs).map(div => ({
                title: div.querySelector('.page-title').value,
                content: div.querySelector('.page-content').innerHTML
            }));
            saveNotebookPagesToDB();
            }

            async function saveNotebookPagesToDB() {
            if (!currentNotebookId) return;
            const notebooks = await getNotebooksFromDB();
            const notebook = notebooks.find(nb => nb.id === currentNotebookId);
            if (!notebook) return;
            notebook.pages = notebookPages;
            // For backward compatibility, also save first page as notebook.content
            notebook.content = notebookPages[0]?.content || '';
            notebook.title = notebookPages[0]?.title || notebook.title;
            await saveNotebookToDB(notebook);
            }

            function removePage(idx) {
            if (notebookPages.length <= 1) return;
            notebookPages.splice(idx, 1);
            renderEditorPages();
            saveNotebookPagesToDB();
            }

            document.getElementById('addPageBtn').addEventListener('click', function() {
            showModal(`
                <h2>Add New Page</h2>
                <form id="addPageForm">
                <input type="text" id="newPageTitle" placeholder="Page Title" required style="width:100%;margin-bottom:16px;" />
                <button type="submit" class="btn" style="width:100%;justify-content:center;">Add Page</button>
                </form>
            `);
            document.getElementById('addPageForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const title = document.getElementById('newPageTitle').value.trim() || 'Untitled Page';
                notebookPages.push({ title, content: '' });
                document.getElementById('modal').remove();
                renderEditorPages();
                saveNotebookPagesToDB();
            });
            });

            // When editor screen is shown, load notebook
            window.addEventListener('hashchange', function() {
            if (window.location.hash.startsWith('#/editor/')) {
                setTimeout(loadNotebookForEditor, 0);
            }
            });
            window.addEventListener('DOMContentLoaded', function() {
            if (window.location.hash.startsWith('#/editor/')) {
                setTimeout(loadNotebookForEditor, 0);
            }
            });

            // Utility
            function escapeHtml(str) {
            return (str || '').replace(/[&<>"']/g, function(m) {
                return ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
                })[m];
            });
            }

            window.addEventListener('DOMContentLoaded', function() {
                // Render notebook title at top of editor
                function renderNotebookTitle() {
                    const notebookNameDiv = document.getElementById('notebookName');
                    if (!notebookNameDiv) return;
                    if (!notebookPages.length) {
                        notebookNameDiv.textContent = '';
                        return;
                    }
                    notebookNameDiv.textContent = notebookPages[0].title || 'Untitled Notebook';
                }

                // Patch renderEditorPages to update notebook title
                const origRenderEditorPages = renderEditorPages;
                renderEditorPages = function() {
                    origRenderEditorPages();
                    renderNotebookTitle();
                };

                // Patch saveEditorPages to update notebook title
                const origSaveEditorPages = saveEditorPages;
                saveEditorPages = function() {
                    origSaveEditorPages();
                    renderNotebookTitle();
                };
            });

            // Share button functionality: Open dialog preview or use native share if available
            document.getElementById('shareBtn').addEventListener('click', async function () {
                // Get notebook title and all pages
                const title = notebookPages[0]?.title || 'Untitled Notebook';
                // Build HTML for preview
                let html = `<h1 style="font-family:Poppins,sans-serif;font-size:2rem;margin-bottom:18px;">${escapeHtml(title)}</h1>`;
                notebookPages.forEach((page, idx) => {
                    html += `<h2 style="font-family:Poppins,sans-serif;font-size:1.2rem;margin-top:32px;margin-bottom:10px;">${escapeHtml(page.title)}</h2>`;
                    html += `<div>${page.content || ''}</div>`;
                    if (idx < notebookPages.length - 1) html += `<div style="page-break-after:always;"></div>`;
                });

                // Show modal dialog with options
                showModal(`
                    <h2>Share Notebook</h2>
                    <div style="margin-bottom:18px;">You can copy a shareable dialog preview, or use your device's share dialog.</div>
                    <button id="openDialogBtn" class="btn" style="width:100%;justify-content:center;margin-bottom:12px;">Open Dialog Preview</button>
                    <button id="nativeShareBtn" class="btn" style="width:100%;justify-content:center;" ${!navigator.share ? 'disabled' : ''}>Share via Device</button>
                `);

                document.getElementById('openDialogBtn').addEventListener('click', function () {
                    // Show a dialog with notebook preview (read-only)
                    showModal(`
                        <h2>Notebook Preview</h2>
                        <div style="max-height:60vh;overflow:auto;background:#fff;color:#222;padding:18px;border-radius:12px;">
                            ${html}
                        </div>
                        <button class="btn" style="width:100%;justify-content:center;margin-top:18px;" onclick="document.getElementById('modal').remove()">Close</button>
                    `);
                });

                document.getElementById('nativeShareBtn').addEventListener('click', async function () {
                    if (!navigator.share) {
                        showToast('Native sharing is not supported on this device.');
                        return;
                    }
                    // Prepare plain text version for sharing
                    let text = `${title}\n\n`;
                    notebookPages.forEach((page, idx) => {
                        text += `--- ${page.title} ---\n`;
                        // Strip HTML tags for plain text
                        const tmp = document.createElement('div');
                        tmp.innerHTML = page.content || '';
                        text += tmp.textContent || tmp.innerText || '';
                        text += '\n\n';
                    });
                    try {
                        await navigator.share({
                            title: title,
                            text: text
                        });
                        // Optionally close modal after sharing
                        const modal = document.getElementById('modal');
                        if (modal) modal.remove();
                    } catch (e) {
                        // User cancelled or error
                    }
                });
            });

            // Toast function
            function showToast(msg) {
                let toast = document.getElementById('customToast');
                if (!toast) {
                    toast = document.createElement('div');
                    toast.id = 'customToast';
                    toast.style.position = 'fixed';
                    toast.style.bottom = '32px';
                    toast.style.left = '50%';
                    toast.style.transform = 'translateX(-50%)';
                    toast.style.background = '#4109c2';
                    toast.style.color = '#fff';
                    toast.style.padding = '14px 32px';
                    toast.style.borderRadius = '32px';
                    toast.style.fontSize = '16px';
                    toast.style.boxShadow = '0 2px 12px rgba(0,0,0,0.15)';
                    toast.style.zIndex = '9999';
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.3s';
                    document.body.appendChild(toast);
                }
                toast.textContent = msg;
                toast.style.opacity = '1';
                setTimeout(() => {
                    toast.style.opacity = '0';
                }, 2200);
            }
            </script>
    </div>
    <script>
        const appsBtn = document.getElementById('appsbtn');
        const appsWrapper = document.querySelector('.apps-wrapper');

        // Make apps-wrapper floating below the button and keep inside viewport
        function positionAppsWrapper() {
            // Only position if visible
            if (appsWrapper.style.display !== 'block') return;
            // Get button position
            const rect = appsBtn.getBoundingClientRect();
            // Set absolute position
            appsWrapper.style.position = 'absolute';
            let top = rect.bottom + window.scrollY + 8;
            let left = rect.left + window.scrollX - 200 + rect.width / 2;
            const minWidth = 320;
            const maxWidth = 450;
            appsWrapper.style.minWidth = minWidth + 'px';
            appsWrapper.style.maxWidth = maxWidth + 'px';
            appsWrapper.style.boxShadow = '0 8px 32px rgba(0,0,0,0.18)';
            appsWrapper.style.zIndex = 2001;

            // Get wrapper size (after display:block)
            appsWrapper.style.visibility = 'hidden';
            appsWrapper.style.display = 'block';
            const wrapperRect = appsWrapper.getBoundingClientRect();
            appsWrapper.style.visibility = '';
            // Adjust left if overflow right
            if (left + wrapperRect.width > window.innerWidth - 8) {
            left = window.innerWidth - wrapperRect.width - 8;
            }
            // Adjust left if overflow left
            if (left < 8) left = 8;
            // Adjust top if overflow bottom
            if (top + wrapperRect.height > window.innerHeight + window.scrollY - 8) {
            top = Math.max(window.innerHeight + window.scrollY - wrapperRect.height - 8, 8 + window.scrollY);
            }
            appsWrapper.style.left = left + 'px';
            appsWrapper.style.top = top + 'px';
        }

        // Toggle apps-wrapper on button click
        appsBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            if (appsWrapper.style.display === 'block') {
            appsWrapper.style.display = 'none';
            } else {
            appsWrapper.style.display = 'block';
            positionAppsWrapper();
            }
        });

        // Reposition on window resize/scroll if open
        window.addEventListener('resize', () => {
            if (appsWrapper.style.display === 'block') positionAppsWrapper();
        });
        window.addEventListener('scroll', () => {
            if (appsWrapper.style.display === 'block') positionAppsWrapper();
        });

        // Close apps-wrapper when clicking outside
        document.addEventListener('click', function (e) {
            if (!appsWrapper.contains(e.target) && e.target !== appsBtn) {
            appsWrapper.style.display = 'none';
            }
        });
        // Set dark mode ON by default if not set
        if (localStorage.getItem('munetios_dark_mode') === null) {
            localStorage.setItem('munetios_dark_mode', 'true');
        }

        // Apply dark/light mode to all elements
        function applyTheme() {
            const darkMode = localStorage.getItem('munetios_dark_mode') === 'true';
            if (darkMode) {
            document.body.style.backgroundColor = '#210041';
            document.body.style.color = '#fff';
            // Set all .liquid-glass backgrounds for dark
            document.querySelectorAll('.liquid-glass').forEach(el => {
                el.style.background = 'rgba(255,255,255,0.1)';
                el.style.borderColor = 'rgba(255,255,255,0.2)';
                el.style.color = '#fff';
            });
            // Set .content backgrounds for dark
            document.querySelectorAll('.content').forEach(el => {
                el.style.background = '';
                el.style.color = '#fff';
            });
            // Set .modal-content backgrounds for dark
            document.querySelectorAll('.modal-content').forEach(el => {
                el.style.background = 'rgba(22,0,58,0.85)';
                el.style.color = '#fff';
            });
            // Set .sidebar backgrounds for dark
            document.querySelectorAll('.sidebar').forEach(el => {
                el.style.background = 'rgba(255,255,255,0.1)';
                el.style.color = '#fff';
            });
            // Set .btn backgrounds for dark
            document.querySelectorAll('.btn').forEach(el => {
                el.style.backgroundColor = '#4109c2';
                el.style.color = '#fff';
            });
            // Set .editor-content background for dark if not custom
            const editorContent = document.querySelector('.editor-content');
            if (editorContent && !localStorage.getItem('editorBgColor')) {
                editorContent.style.background = '';
            }
            } else {
            document.body.style.backgroundColor = '#fff';
            document.body.style.color = '#222';
            document.querySelectorAll('.liquid-glass').forEach(el => {
                el.style.background = 'rgba(0,0,0,0.04)';
                el.style.borderColor = 'rgba(0,0,0,0.08)';
                el.style.color = '#222';
            });
            document.querySelectorAll('.content').forEach(el => {
                el.style.background = '';
                el.style.color = '#222';
            });
            document.querySelectorAll('.modal-content').forEach(el => {
                el.style.background = '#fff';
                el.style.color = '#222';
            });
            document.querySelectorAll('.sidebar').forEach(el => {
                el.style.background = 'rgba(0,0,0,0.04)';
                el.style.color = '#222';
            });
            document.querySelectorAll('.btn').forEach(el => {
                el.style.backgroundColor = '#e0e0e0';
                el.style.color = '#222';
            });
            const editorContent = document.querySelector('.editor-content');
            if (editorContent && !localStorage.getItem('editorBgColor')) {
                editorContent.style.background = '';
            }
            }
        }

        // Apply theme on load
        window.addEventListener('DOMContentLoaded', applyTheme);

        document.getElementById('settingsbtn').addEventListener('click', function () {
            showSettingsModal();
        });

        function showSettingsModal() {
            // Get current dark mode state
            const darkMode = localStorage.getItem('munetios_dark_mode') === 'true';
            // Get current language
            const lang = localStorage.getItem('munetios_lang') || 'en';
            const languages = [
            { code: 'en', label: 'English' },
            { code: 'es', label: 'Spanish' },
            { code: 'de', label: 'German' },
            { code: 'fr', label: 'French' },
            { code: 'zh', label: 'Chinese' },
            { code: 'ja', label: 'Japanese' },
            { code: 'ko', label: 'Korean' },
            { code: 'pt', label: 'Portuguese' }
            ];
            showModal(`
            <h2>Settings</h2>
            <div style="display:flex;flex-direction:column;gap:18px;">
                <div>
                <label style="display:flex;align-items:center;gap:12px;cursor:pointer;">
                    <input type="checkbox" id="darkModeToggle" ${darkMode ? 'checked' : ''} style="width:20px;height:20px;">
                    <span>Dark Mode</span>
                </label>
                </div>
                <div>
                <label for="langSelect" style="margin-bottom:6px;display:block;">Language</label>
                <select id="langSelect" style="width:100%;padding:8px 12px;border-radius:8px;">
                    ${languages.map(l => `<option value="${l.code}" ${l.code === lang ? 'selected' : ''}>${l.label}</option>`).join('')}
                </select>
                </div>
                <div style="display:flex;gap:12px;flex-wrap:wrap;">
                <button class="btn" id="exportDataBtn" style="flex:1;">Export Data</button>
                <button class="btn" id="importDataBtn" style="flex:1;">Import Data</button>
                <button class="btn" id="deleteAllDataBtn" style="flex:1;background:#c20909;">Delete All Data</button>
                </div>
                <button class="btn" style="width:100%;justify-content:center;margin-top:12px;" onclick="document.getElementById('modal').remove()">Close</button>
            </div>
            `);

            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('change', function () {
            localStorage.setItem('munetios_dark_mode', this.checked ? 'true' : 'false');
            applyTheme();
            });

            // On load, apply theme
            applyTheme();

            // Language select
            document.getElementById('langSelect').addEventListener('change', function () {
            localStorage.setItem('munetios_lang', this.value);
            showToast('Language preference saved.');
            });

            // Export data
            document.getElementById('exportDataBtn').addEventListener('click', async function () {
            const db = await openDB();
            const notebooks = await getNotebooksFromDB();
            const tags = await getTagsFromDB();
            // Export all data in one object
            const exportData = {
                notebooks,
                tags,
                settings: {
                darkMode: localStorage.getItem('munetios_dark_mode') || null,
                lang: localStorage.getItem('munetios_lang') || null
                }
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'munetios-notebook-export.json';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                URL.revokeObjectURL(a.href);
                a.remove();
            }, 100);
            showToast('Data exported.');
            });

            // Import data
            document.getElementById('importDataBtn').addEventListener('click', function () {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,application/json';
            input.style.display = 'none';
            input.addEventListener('change', async function () {
                if (!input.files || !input.files[0]) return;
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = async function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.notebooks && Array.isArray(data.notebooks)) {
                    // Import notebooks
                    for (const nb of data.notebooks) {
                        await saveNotebookToDB(nb);
                    }
                    }
                    if (data.tags && Array.isArray(data.tags)) {
                    for (const tag of data.tags) {
                        await saveTagToDB(tag);
                    }
                    }
                    if (data.settings) {
                    if ('darkMode' in data.settings) localStorage.setItem('munetios_dark_mode', data.settings.darkMode);
                    if ('lang' in data.settings) localStorage.setItem('munetios_lang', data.settings.lang);
                    applyTheme();
                    }
                    showToast('Data imported.');
                    document.getElementById('modal').remove();
                    renderNotebooks && renderNotebooks();
                } catch (err) {
                    showToast('Import failed.');
                }
                };
                reader.readAsText(file);
            });
            document.body.appendChild(input);
            input.click();
            setTimeout(() => input.remove(), 1000);
            });

            // Delete all data
            document.getElementById('deleteAllDataBtn').addEventListener('click', function () {
            showDeleteConfirmModal(1);
            });
        }

        // Delete confirmation with 5 warnings
        function showDeleteConfirmModal(step) {
            const warnings = [
            "Warning 1: This will delete ALL your notebooks, tags, and settings.",
            "Warning 2: This action cannot be undone.",
            "Warning 3: All your data will be lost permanently.",
            "Warning 4: Are you absolutely sure you want to proceed?",
            "Final Warning: This is your last chance to export your data!"
            ];
            let html = `<h2>Delete All Data</h2>
            <div style="color:#c20909;font-weight:600;margin-bottom:18px;">${warnings[step - 1]}</div>`;
            if (step < 5) {
            html += `<button class="btn" style="width:100%;justify-content:center;background:#c20909;" id="nextDeleteStepBtn">Continue</button>
            <button class="btn" style="width:100%;justify-content:center;margin-top:12px;" onclick="document.getElementById('modal').remove()">Cancel</button>`;
            } else {
            html += `<button class="btn" id="exportBeforeDeleteBtn" style="width:100%;justify-content:center;margin-bottom:12px;">Export Data</button>
            <button class="btn" style="width:100%;justify-content:center;background:#c20909;" id="finalDeleteBtn">Delete Everything</button>
            <button class="btn" style="width:100%;justify-content:center;margin-top:12px;" onclick="document.getElementById('modal').remove()">Cancel</button>`;
            }
            showModal(html);

            if (step < 5) {
            document.getElementById('nextDeleteStepBtn').addEventListener('click', function () {
                showDeleteConfirmModal(step + 1);
            });
            } else {
            // Export before delete
            document.getElementById('exportBeforeDeleteBtn').addEventListener('click', async function () {
                const notebooks = await getNotebooksFromDB();
                const tags = await getTagsFromDB();
                const exportData = {
                notebooks,
                tags,
                settings: {
                    darkMode: localStorage.getItem('munetios_dark_mode') || null,
                    lang: localStorage.getItem('munetios_lang') || null
                }
                };
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'munetios-notebook-export.json';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                URL.revokeObjectURL(a.href);
                a.remove();
                }, 100);
                showToast('Data exported.');
            });
            // Final delete
            document.getElementById('finalDeleteBtn').addEventListener('click', async function () {
                // Delete IndexedDB
                indexedDB.deleteDatabase('munetios_notebook');
                // Remove settings
                localStorage.removeItem('munetios_dark_mode');
                localStorage.removeItem('munetios_lang');
                showToast('All data deleted.');
                document.getElementById('modal').remove();
                setTimeout(() => location.reload(), 1200);
            });
            }
        }


        document.getElementById('helpbtn').addEventListener('click', function () {
            showModal(`
                <h2>How to Use Munetios Notebook</h2>
                <div style="max-height:60vh;overflow:auto;">
                    <h3>Getting Started</h3>
                    <ul>
                        <li><b>Create:</b> Click the <b>Create</b> button to add a new notebook. You can set a title, description, and tags.</li>
                        <li><b>Edit:</b> Click a notebook to open the editor. Add pages, format text, insert images or videos, and organize your content.</li>
                        <li><b>Tags:</b> Use tags to categorize notebooks. Manage tags in the <b>Tags</b> section.</li>
                        <li><b>Archive/Trash:</b> Move notebooks to <b>Archive</b> or <b>Trash</b> from the editor's <b>More</b> menu.</li>
                        <li><b>Export:</b> Download your notebook as TXT or Markdown from the <b>More</b> menu.</li>
                        <li><b>Share:</b> Use the <b>Share</b> button in the editor to preview or share your notebook.</li>
                    </ul>
                    <h3>Terms of Service</h3>
                    <p>
                        By using Munetios Notebook, you agree to use the app for lawful purposes only. You are responsible for your own content. The app is provided "as is" without warranty. We are not liable for any data loss or damages.
                    </p>
                    <h3>Privacy Policy</h3>
                    <p>
                        Munetios Notebook stores your data locally in your browser using IndexedDB. Your notes and tags are not uploaded or shared with any server. We do not collect or transmit your personal information.
                    </p>
                    <button class="btn" style="width:100%;justify-content:center;margin-top:18px;" onclick="document.getElementById('modal').remove()">Close</button>
                </div>
            `);
        });



        document.getElementById('sortBySelect').addEventListener('change', async function () {
            await renderNotebooks();
        });

        async function renderNotebooks() {
            const notebooks = await getNotebooksFromDB();
            const container = document.getElementById('notebooks');
            if (!container) return;
            // Filter out archived and trashed notebooks
            const visibleNotebooks = notebooks.filter(nb => !nb.archived && !nb.trashed);
            container.innerHTML = '';
            if (visibleNotebooks.length === 0) {
                container.innerHTML = '<div style="color:#e0d6f7;">No notebooks yet. Click Create to add one.</div>';
                return;
            }
            // Sort notebooks
            const sortValue = document.getElementById('sortBySelect').value;
            let sorted = [...visibleNotebooks];
            sorted.sort((a, b) => {
                if (sortValue === 'lastModifiedDesc') {
                    return (b.updatedAt || b.id) - (a.updatedAt || a.id);
                } else if (sortValue === 'lastModifiedAsc') {
                    return (a.updatedAt || a.id) - (b.updatedAt || b.id);
                } else if (sortValue === 'createdDesc') {
                    return (b.createdAt || b.id) - (a.createdAt || a.id);
                } else if (sortValue === 'createdAsc') {
                    return (a.createdAt || a.id) - (b.createdAt || b.id);
                } else if (sortValue === 'titleAsc') {
                    return (a.title || '').localeCompare(b.title || '');
                } else if (sortValue === 'titleDesc') {
                    return (b.title || '').localeCompare(a.title || '');
                }
                return 0;
            });
            sorted.forEach(nb => {
                const div = document.createElement('div');
                div.className = 'liquid-glass';
                div.style.padding = '18px';
                div.style.marginBottom = '18px';
                div.style.cursor = 'pointer';
                div.style.borderRadius = '24px';
                div.style.transition = 'background 0.2s,transform 0.2s';
                div.style.boxShadow = '0 2px 12px rgba(0,0,0,0.08)';
                div.addEventListener('click', () => {
                    window.location.hash = `#/editor/${nb.id}`;
                });
                div.innerHTML = `
                    <div style="font-size:20px;font-weight:600;">${nb.title}</div>
                    ${nb.desc ? `<div style="color:#e0d6f7;margin:6px 0 0 0;">${nb.desc}</div>` : ''}
                    ${nb.tags && nb.tags.length ? `<div style="margin-top:8px;">${nb.tags.map(tag => `<span style="background:#4109c2;color:#fff;padding:3px 10px;border-radius:16px;font-size:13px;margin-right:6px;">${tag}</span>`).join('')}</div>` : ''}
                `;
                container.appendChild(div);
            });
        }

        // Patch saveNotebookToDB to update createdAt/updatedAt
        const origSaveNotebookToDB = saveNotebookToDB;
        saveNotebookToDB = async function (notebook) {
            if (!notebook.createdAt) notebook.createdAt = Date.now();
            notebook.updatedAt = Date.now();
            return origSaveNotebookToDB(notebook);
        };


        // Show content section by id
        function showContent(contentId) {
            // Hide all .content sections
            document.querySelectorAll('.content').forEach(div => div.style.display = 'none');
            // Show the requested section
            const el = document.getElementById(contentId);
            if (el) el.style.display = '';
            // Show or hide the home screen depending on the section
            if (contentId === 'notebooksContent') {
            document.querySelector('.home-screen').style.display = '';
            } else {
            document.querySelector('.home-screen').style.display = 'block';
            }
        }

        // Map hash routes to content ids and sidebar indices
        const routeMap = {
            '': { id: 'notebooksContent', idx: 0 },
            '/tags': { id: 'tagsContent', idx: 1 },
            '/archives': { id: 'archivesContent', idx: 2 },
            '/trash': { id: 'trashContent', idx: 3 }
        };

        // Handle hash-based routing for sidebar content
        function handleSidebarRoute() {
            // Ignore editor route
            if (window.location.hash.startsWith('#/editor/')) return;
            let hash = window.location.hash.replace(/^#/, '');
            if (hash.startsWith('/')) hash = hash;
            else hash = '';
            const route = routeMap[hash] || routeMap[''];
            showContent(route.id);
            // Set active sidebar item
            document.querySelectorAll('.sidebar-item').forEach((i, idx) => {
            if (idx === route.idx) i.classList.add('active');
            else i.classList.remove('active');
            });
        }

        // Sidebar click handlers
        document.querySelectorAll('.sidebar-item').forEach((item, idx) => {
            item.addEventListener('click', () => {
            // Remove active state from all
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            // Switch hash to trigger route
            if (idx === 0) window.location.hash = '';
            else if (idx === 1) window.location.hash = '/tags';
            else if (idx === 2) window.location.hash = '/archives';
            else if (idx === 3) window.location.hash = '/trash';
            });
        });

        // Listen for hash changes
        window.addEventListener('hashchange', handleSidebarRoute);

        // Show notebooks by default on load
        window.addEventListener('DOMContentLoaded', function() {
            handleSidebarRoute();
        });


        document.getElementById('searchInput').addEventListener('input', async function () {
            const query = this.value.trim().toLowerCase();
            const notebooks = await getNotebooksFromDB();
            const container = document.getElementById('notebooks');
            if (!container) return;
            container.innerHTML = '';
            const filtered = query
                ? notebooks.filter(nb =>
                    (nb.title && nb.title.toLowerCase().includes(query)) ||
                    (nb.desc && nb.desc.toLowerCase().includes(query)) ||
                    (nb.tags && nb.tags.some(tag => tag.toLowerCase().includes(query)))
                )
                : notebooks;
            if (filtered.length === 0) {
                container.innerHTML = '<div style="color:#e0d6f7;">No notebooks found.</div>';
                return;
            }
            filtered.forEach(nb => {
                const div = document.createElement('div');
                div.className = 'liquid-glass';
                div.style.padding = '18px';
                div.style.marginBottom = '18px';
                div.style.cursor = 'pointer';
                div.style.borderRadius = '24px';
                div.style.transition = 'background 0.2s,transform 0.2s';
                div.style.boxShadow = '0 2px 12px rgba(0,0,0,0.08)';
                div.addEventListener('click', () => {
                    window.location.hash = `#/editor/${nb.id}`;
                });
                div.innerHTML = `
                    <div style="font-size:20px;font-weight:600;">${nb.title}</div>
                    ${nb.desc ? `<div style="color:#e0d6f7;margin:6px 0 0 0;">${nb.desc}</div>` : ''}
                    ${nb.tags && nb.tags.length ? `<div style="margin-top:8px;">${nb.tags.map(tag => `<span style="background:#4109c2;color:#fff;padding:3px 10px;border-radius:16px;font-size:13px;margin-right:6px;">${tag}</span>`).join('')}</div>` : ''}
                `;
                container.appendChild(div);
            });
        });


        document.getElementById('backHome').addEventListener('click', function() {
            document.querySelector('.editor-screen').style.display = 'none';
            document.querySelector('.home-screen').style.display = '';
            window.location.hash = '';
        });



        // (Removed duplicate localStorage-based tag add/delete and tag rendering code)
        // IndexedDB helpers
        function openDB() {
            return new Promise((resolve, reject) => {
            const request = indexedDB.open('munetios_notebook', 1);
            request.onupgradeneeded = function(e) {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('notebooks')) {
            db.createObjectStore('notebooks', { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains('tags')) {
            db.createObjectStore('tags', { keyPath: 'name' });
            }
            };
            request.onsuccess = function(e) {
            resolve(e.target.result);
            };
            request.onerror = function(e) {
            reject(e.target.error);
            };
            });
        }

        async function saveNotebookToDB(notebook) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
            const tx = db.transaction('notebooks', 'readwrite');
            tx.objectStore('notebooks').put(notebook);
            tx.oncomplete = resolve;
            tx.onerror = reject;
            });
        }

        async function getNotebooksFromDB() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
            const tx = db.transaction('notebooks', 'readonly');
            const store = tx.objectStore('notebooks');
            const req = store.getAll();
            req.onsuccess = () => resolve(req.result);
            req.onerror = reject;
            });
        }

        async function saveTagToDB(tagName) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
            const tx = db.transaction('tags', 'readwrite');
            tx.objectStore('tags').put({ name: tagName });
            tx.oncomplete = resolve;
            tx.onerror = reject;
            });
        }

        async function deleteTagFromDB(tagName) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
            const tx = db.transaction('tags', 'readwrite');
            tx.objectStore('tags').delete(tagName);
            tx.oncomplete = resolve;
            tx.onerror = reject;
            });
        }

        async function getTagsFromDB() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
            const tx = db.transaction('tags', 'readonly');
            const store = tx.objectStore('tags');
            const req = store.getAll();
            req.onsuccess = () => resolve(req.result.map(t => t.name));
            req.onerror = reject;
            });
        }

        // Patch tag add/delete to use IndexedDB
        document.getElementById('addTagBtn').addEventListener('click', async function() {
            const tagName = document.getElementById('newTagInput').value.trim();
            if (tagName) {
            const tagDiv = document.createElement('div');
            tagDiv.textContent = tagName;
            tagDiv.style.padding = '10px';
            tagDiv.style.border = '1px solid rgba(255, 255, 255, 0.2)';
            tagDiv.style.borderRadius = '8px';
            tagDiv.style.marginBottom = '8px';
            tagDiv.style.display = 'flex';
            tagDiv.style.alignItems = 'center';
            tagDiv.style.justifyContent = 'space-between';

            // Create delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '&times;';
            deleteBtn.style.background = 'none';
            deleteBtn.style.border = 'none';
            deleteBtn.style.color = '#fff';
            deleteBtn.style.fontSize = '20px';
            deleteBtn.style.cursor = 'pointer';
            deleteBtn.style.marginLeft = '12px';
            deleteBtn.title = 'Delete tag';

            deleteBtn.addEventListener('click', async function(e) {
            e.stopPropagation();
            tagDiv.remove();
            await deleteTagFromDB(tagName);
            });

            // Wrap tag name in a span for layout
            const tagNameSpan = document.createElement('span');
            tagNameSpan.textContent = tagName;

            tagDiv.textContent = '';
            tagDiv.appendChild(tagNameSpan);
            tagDiv.appendChild(deleteBtn);

            document.getElementById('tags').appendChild(tagDiv);
            document.getElementById('newTagInput').value = '';

            // Save to IndexedDB
            await saveTagToDB(tagName);
            }
        });

        // On page load, render tags from IndexedDB
        window.addEventListener('DOMContentLoaded', async function() {
            const tags = await getTagsFromDB();
            tags.forEach(function(tagName) {
            const tagDiv = document.createElement('div');
            tagDiv.textContent = tagName;
            tagDiv.style.padding = '10px';
            tagDiv.style.border = '1px solid rgba(255, 255, 255, 0.2)';
            tagDiv.style.borderRadius = '8px';
            tagDiv.style.marginBottom = '8px';
            tagDiv.style.display = 'flex';
            tagDiv.style.alignItems = 'center';
            tagDiv.style.justifyContent = 'space-between';

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '&times;';
            deleteBtn.style.background = 'none';
            deleteBtn.style.border = 'none';
            deleteBtn.style.color = '#fff';
            deleteBtn.style.fontSize = '20px';
            deleteBtn.style.cursor = 'pointer';
            deleteBtn.style.marginLeft = '12px';
            deleteBtn.title = 'Delete tag';

            deleteBtn.addEventListener('click', async function(e) {
            e.stopPropagation();
            tagDiv.remove();
            await deleteTagFromDB(tagName);
            });

            const tagNameSpan = document.createElement('span');
            tagNameSpan.textContent = tagName;

            tagDiv.textContent = '';
            tagDiv.appendChild(tagNameSpan);
            tagDiv.appendChild(deleteBtn);

            document.getElementById('tags').appendChild(tagDiv);
            });
            // Render notebooks from IndexedDB on load
            renderNotebooks();

            // Handle hash-based routing for editor
            window.addEventListener('hashchange', handleHashRoute);
            async function handleHashRoute() {
            const hash = window.location.hash;
            const match = hash.match(/^#\/editor\/(.+)$/);
            if (match) {
                const id = match[1];
                const notebooks = await getNotebooksFromDB();
                const notebook = notebooks.find(nb => nb.id === id);
                if (notebook) {
                openEditor(notebook, true);
                }
            } else {
                // If not in editor route, show home screen
                document.querySelector('.editor-screen').style.display = 'none';
                document.querySelector('.home-screen').style.display = '';
            }
            }
            // On load, check hash
            handleHashRoute();
        });

        // (Removed duplicate renderNotebooks function to avoid conflicts with sorting)

        // Save notebook to IndexedDB and open editor
        document.getElementById('createbtn').addEventListener('click', async function() {
            const tags = await getTagsFromDB();
            const tagOptions = tags.map(tag => `<option value="${tag}">${tag}</option>`).join('');
            showModal(`
            <h2>Create New Notebook</h2>
            <form id="newNotebookForm" autocomplete="off">
            <div style="margin-bottom:12px;">
            <input type="text" id="notebookTitle" placeholder="Title" required style="width:100%;" />
            </div>
            <div style="margin-bottom:12px;">
            <textarea id="notebookDesc" placeholder="Description (optional)" style="width:100%;resize:vertical;"></textarea>
            </div>
            <div style="margin-bottom:18px;">
            <select id="notebookTags" multiple style="width:100%;min-height:38px;">
            ${tagOptions}
            </select>
            <div style="font-size:12px;color:#e0d6f7;margin-top:4px;">Hold Ctrl (Cmd on Mac) to select multiple tags</div>
            </div>
            <button type="submit" class="btn" style="width:100%;justify-content:center;">
            <span>Create Notebook</span>
            </button>
            <button type="button" class="btn" id="importNotebookBtn" style="width:100%;justify-content:center;margin-top:10px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 3v12m0 0l-4-4m4 4l4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <rect x="4" y="17" width="16" height="4" rx="2" stroke="currentColor" stroke-width="2"/>
            </svg>
            <div class="create-label">Import Notebook</div>
            </button>
            </form>
            `);

            document.getElementById('newNotebookForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const title = document.getElementById('notebookTitle').value.trim();
            const desc = document.getElementById('notebookDesc').value.trim();
            const tagSelect = document.getElementById('notebookTags');
            const selectedTags = Array.from(tagSelect.selectedOptions).map(opt => opt.value);

            if (!title) return;

            // Save notebook to IndexedDB
            const id = 'nb_' + Date.now();
            const notebook = { id, title, desc, tags: selectedTags, content: '' };
            await saveNotebookToDB(notebook);

            document.getElementById('modal').remove();
            renderNotebooks();
            window.location.hash = `#/editor/${id}`;
            });

            // Import notebook (txt, html, md) inside create modal
            document.getElementById('importNotebookBtn').addEventListener('click', function() {
            // Show import UI inside modal
            const modalContent = document.querySelector('#modal .modal-content');
            if (!modalContent) return;
            // Remove any previous import UI
            const oldImport = document.getElementById('importNotebookFileRow');
            if (oldImport) oldImport.remove();
            // Insert import UI before the form buttons
            const importDiv = document.createElement('div');
            importDiv.id = 'importNotebookFileRow';
            importDiv.innerHTML = `
                <div style="margin-bottom:12px;">
                <input type="file" id="importNotebookFile" accept=".txt,.md,.markdown,.html,text/plain,text/html,text/markdown" style="width:100%;" />
                </div>
                <div style="font-size:13px;color:#e0d6f7;margin-bottom:12px;">
                Supported: Plain Text (.txt), HTML (.html), Markdown (.md)
                </div>
                <button class="btn" id="importNotebookGoBtn" style="width:100%;justify-content:center;" disabled>Import</button>
            `;
            // Insert after the form fields but before the buttons
            const form = document.getElementById('newNotebookForm');
            form.insertBefore(importDiv, form.querySelector('button[type="submit"]'));

            const fileInput = document.getElementById('importNotebookFile');
            const importBtn = document.getElementById('importNotebookGoBtn');
            fileInput.addEventListener('change', function() {
                importBtn.disabled = !fileInput.files || !fileInput.files[0];
            });
            importBtn.addEventListener('click', async function() {
                if (!fileInput.files || !fileInput.files[0]) return;
                const file = fileInput.files[0];
                const ext = file.name.split('.').pop().toLowerCase();
                const reader = new FileReader();
                reader.onload = async function(e) {
                let content = e.target.result;
                let title = file.name.replace(/\.[^/.]+$/, '');
                let pages = [];
                if (ext === 'txt') {
                    // Each line break as new paragraph, all in one page
                    pages = [{
                    title: title,
                    content: '<pre style="white-space:pre-wrap;font-family:inherit;">' + escapeHtml(content) + '</pre>'
                    }];
                } else if (ext === 'html' || file.type === 'text/html') {
                    // Try to extract <title> and <body>
                    let doc = document.createElement('html');
                    doc.innerHTML = content;
                    let pageTitle = doc.querySelector('title') ? doc.querySelector('title').textContent : title;
                    let body = doc.querySelector('body') ? doc.querySelector('body').innerHTML : content;
                    pages = [{
                    title: pageTitle,
                    content: body
                    }];
                } else if (ext === 'md' || ext === 'markdown' || file.type === 'text/markdown') {
                    // Basic Markdown to HTML conversion (headings, bold, italic, lists, code, links)
                    let lines = content.split(/\r?\n/);
                    let currentPage = { title: title, content: '' };
                    let html = '';
                    let inList = false, inOl = false, inCode = false;
                    for (let i = 0; i < lines.length; ++i) {
                    let line = lines[i];
                    if (/^#{1,6}\s/.test(line)) {
                        let level = line.match(/^#+/)[0].length;
                        let text = line.replace(/^#{1,6}\s/, '');
                        if (html) html += '</div>';
                        html += `<h${level}>${escapeHtml(text)}</h${level}><div>`;
                    } else if (/^[-*+]\s+/.test(line)) {
                        if (!inList) { html += '<ul>'; inList = true; }
                        html += `<li>${escapeHtml(line.replace(/^[-*+]\s+/, ''))}</li>`;
                    } else if (/^\d+\.\s+/.test(line)) {
                        if (!inOl) { html += '<ol>'; inOl = true; }
                        html += `<li>${escapeHtml(line.replace(/^\d+\.\s+/, ''))}</li>`;
                    } else if (/^```/.test(line)) {
                        if (!inCode) { html += '<pre><code>'; inCode = true; }
                        else { html += '</code></pre>'; inCode = false; }
                    } else if (inCode) {
                        html += escapeHtml(line) + '\n';
                    } else if (line.trim() === '') {
                        if (inList) { html += '</ul>'; inList = false; }
                        if (inOl) { html += '</ol>'; inOl = false; }
                        html += '<br>';
                    } else {
                        // Inline formatting: bold, italic, links
                        let l = escapeHtml(line)
                        .replace(/\*\*(.+?)\*\*/g, '<b>$1</b>')
                        .replace(/\*(.+?)\*/g, '<i>$1</i>')
                        .replace(/__(.+?)__/g, '<u>$1</u>')
                        .replace(/~~(.+?)~~/g, '<s>$1</s>')
                        .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
                        html += l + '<br>';
                    }
                    }
                    if (inList) html += '</ul>';
                    if (inOl) html += '</ol>';
                    if (inCode) html += '</code></pre>';
                    if (html) html = `<div>${html}</div>`;
                    currentPage.content = html;
                    pages = [currentPage];
                } else {
                    // Fallback: treat as plain text
                    pages = [{
                    title: title,
                    content: '<pre style="white-space:pre-wrap;font-family:inherit;">' + escapeHtml(content) + '</pre>'
                    }];
                }
                // Save notebook
                const id = 'nb_' + Date.now();
                const notebook = {
                    id,
                    title: pages[0].title || title,
                    desc: '',
                    tags: [],
                    pages: pages,
                    content: pages[0].content || ''
                };
                await saveNotebookToDB(notebook);
                document.getElementById('modal').remove();
                renderNotebooks();
                window.location.hash = `#/editor/${id}`;
                showToast('Notebook imported.');
                };
                reader.readAsText(file);
            });
            });
        });
        /**
         * Sanitize HTML to prevent XSS/script injection.
         * Removes <script>, <iframe>, <object>, <embed>, <link>, <style>, <form>, <meta>, <base>, <svg>, <math>, <frame>, <frameset>, <applet>, <input>, <button>, <textarea>, <select>, <option>, <noscript>, <audio>, <video> (except <video> with <source>), and all event handler attributes (on*).
         * Allows only safe tags and attributes.
         */
        function sanitizeHtml(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString('<div>' + html + '</div>', 'text/html');
            const ALLOWED_TAGS = [
                'b', 'i', 'u', 's', 'strong', 'em', 'br', 'p', 'ul', 'ol', 'li', 'pre', 'code', 'blockquote',
                'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'span', 'div', 'img', 'a', 'hr', 'video', 'source'
            ];
            const ALLOWED_ATTRS = {
                'a': ['href', 'target', 'rel'],
                'img': ['src', 'alt', 'title', 'width', 'height', 'style'],
                'video': ['controls', 'width', 'height', 'style'],
                'source': ['src', 'type'],
                'span': ['style'],
                'div': ['style'],
                'pre': ['style'],
                'code': ['style'],
                '*': ['style']
            };
            function clean(node) {
                // Remove disallowed tags
                if (node.nodeType === 1) {
                    const tag = node.tagName.toLowerCase();
                    if (!ALLOWED_TAGS.includes(tag)) {
                        node.remove();
                        return;
                    }
                    // Remove all event handler attributes and javascript: URLs
                    [...node.attributes].forEach(attr => {
                        const name = attr.name.toLowerCase();
                        const value = attr.value;
                        // Remove event handlers and dangerous attributes
                        if (name.startsWith('on') || name === 'srcdoc' || name === 'data' || name === 'formaction') {
                            node.removeAttribute(attr.name);
                        } else if (name === 'href' || name === 'src') {
                            if (/^\s*javascript:/i.test(value) || /^\s*data:/i.test(value) && tag !== 'img' && tag !== 'source') {
                                node.removeAttribute(attr.name);
                            }
                        } else if (
                            !(ALLOWED_ATTRS[tag] && ALLOWED_ATTRS[tag].includes(name)) &&
                            !(ALLOWED_ATTRS['*'] && ALLOWED_ATTRS['*'].includes(name))
                        ) {
                            node.removeAttribute(attr.name);
                        }
                    });
                    // Special: <video> only allow <source> as children, remove others
                    if (tag === 'video') {
                        Array.from(node.childNodes).forEach(child => {
                            if (child.nodeType === 1 && child.tagName.toLowerCase() !== 'source') {
                                child.remove();
                            }
                        });
                    }
                }
                // Recursively clean children
                Array.from(node.childNodes).forEach(clean);
            }
            clean(doc.body.firstChild);
            return doc.body.firstChild.innerHTML;
        }

        // Patch all notebook content saves to sanitize HTML
        const origSaveEditorPagesForSanitize = saveEditorPages;
        saveEditorPages = function() {
            // Sanitize all page contents before saving
            const pageDivs = document.querySelectorAll('.editor-page');
            notebookPages = Array.from(pageDivs).map(div => ({
                title: div.querySelector('.page-title').value,
                content: sanitizeHtml(div.querySelector('.page-content').innerHTML)
            }));
            saveNotebookPagesToDB();
        };

        // Patch import notebook to sanitize imported HTML
        const origImportNotebook = window.importNotebookFromFile;
        window.importNotebookFromFile = function(file, ext, content) {
            if (ext === 'html' || ext === 'htm') {
                // Sanitize imported HTML
                let doc = document.createElement('html');
                doc.innerHTML = content;
                let pageTitle = doc.querySelector('title') ? doc.querySelector('title').textContent : file.name.replace(/\.[^/.]+$/, '');
                let body = doc.querySelector('body') ? doc.querySelector('body').innerHTML : content;
                body = sanitizeHtml(body);
                return [{ title: pageTitle, content: body }];
            }
            // fallback to original if not html
            return origImportNotebook ? origImportNotebook(file, ext, content) : null;
        };

        // Patch renderEditorPages to sanitize on display (defense in depth)
        const origRenderEditorPagesForSanitize = renderEditorPages;
        renderEditorPages = function() {
            origRenderEditorPagesForSanitize();
            // Sanitize all .page-content after rendering
            document.querySelectorAll('.editor-page .page-content').forEach(div => {
                div.innerHTML = sanitizeHtml(div.innerHTML);
            });
        };
        // Open editor without injecting content
        function openEditor(notebook, fromRoute) {
            document.querySelector('.home-screen').style.display = 'none';
            const editor = document.querySelector('.editor-screen');
            editor.style.display = 'block';
            // Do not inject any content, just show the editor screen
        }

        function showModal(html) {
            // Remove existing modal if any
            const oldModal = document.getElementById('modal');
            if (oldModal) oldModal.remove();

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'modal';
            modal.innerHTML = `<div class="modal-content">${html}</div>`;
            document.body.appendChild(modal);

            // Close modal on background click
            modal.addEventListener('click', function(e) {
            if (e.target === modal) modal.remove();
            });
        }

        // (Removed duplicate localStorage-based create, render, and openEditor functions)
        
    </script>
</body>
</html> 





